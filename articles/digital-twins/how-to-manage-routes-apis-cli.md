---
# Mandatory fields.
title: Manage endpoints and routes (APIs and CLI)
titleSuffix: Azure Digital Twins
description: See how to set up and manage endpoints and event routes for Azure Digital Twins data.
author: alexkarcher-msft
ms.author: alkarche # Microsoft employees only
ms.date: 10/12/2020
ms.topic: how-to
ms.service: digital-twins

# Optional fields. Don't forget to remove # if you need a field.
# ms.custom: can-be-multiple-comma-separated
# ms.reviewer: MSFT-alias-of-reviewer
# manager: MSFT-alias-of-manager-or-PM-counterpart
---

# Manage endpoints and routes in Azure Digital Twins (APIs and CLI)

[!INCLUDE [digital-twins-route-selector.md](../../includes/digital-twins-route-selector.md)]

In Azure Digital Twins, you can route [event notifications](how-to-interpret-event-data.md) to downstream services or connected compute resources. This is done by first setting up **endpoints** that can receive the events. You can then create  [**event routes**](concepts-route-events.md) that specify which events generated by Azure Digital Twins are delivered to which endpoints.

Endpoints and routes can be managed with the [EventRoutes APIs](how-to-use-apis-sdks.md), the [.NET (C#) SDK](https://github.com/Azure/azure-sdk-for-net/tree/master/sdk/digitaltwins/Azure.DigitalTwins.Core), or the [Azure Digital Twins CLI](how-to-use-cli.md). This article walks you through the process of creating endpoints and routes through these mechanisms.

They can also be managed through the [Azure portal](https://portal.azure.com). For a version of this article that uses the portal instead, see [*How-to: Manage endpoints and routes (portal)*](how-to-manage-routes-portal.md).

## Prerequisites

* You'll need an **Azure account** (you can set one up for free [here](https://azure.microsoft.com/free/?WT.mc_id=A261C142F))
* You'll need an **Azure Digital Twins instance** in your Azure subscription. If you don't have an instance already, you can create one using the steps in [*How-to: Set up an instance and authentication*](how-to-set-up-instance-portal.md). Have the following values from setup handy to use later in this article:
    - Instance name
    - Resource group
    
## Create an endpoint for Azure Digital Twins

These are the supported types of endpoints that you can create for your instance:
* [Event Grid](../event-grid/overview.md)
* [Event Hubs](../event-hubs/event-hubs-about.md)
* [Service Bus](../service-bus-messaging/service-bus-messaging-overview.md)

For more information on the different endpoint types, see [*Choose between Azure messaging services*](../event-grid/compare-messaging-services.md).

To link an endpoint to Azure Digital Twins, the event grid topic, event hub, or Service Bus that you're using for the endpoint needs to exist already. 

### Create an Event Grid endpoint

The following example shows how to create an event grid-type endpoint using the Azure CLI. You can use [Azure Cloud Shell](https://shell.azure.com), or [install the CLI locally](/cli/azure/install-azure-cli?preserve-view=true&view=azure-cli-latest).

First, create an event grid topic. You can use the following command, or view the steps in more detail by visiting [the *Create a custom topic* section](../event-grid/custom-event-quickstart-portal.md#create-a-custom-topic) of the Event Grid *Custom events* quickstart.

```azurecli
az eventgrid topic create -g <your-resource-group-name> --name <your-topic-name> -l <region>
```

> [!TIP]
> To output a list of Azure region names that can be passed into commands in the Azure CLI, run this command:
> ```azurecli
> az account list-locations -o table
> ```

Once you have created the topic, you can link it to Azure Digital Twins with the following [Azure Digital Twins CLI command](how-to-use-cli.md):

```azurecli
az dt endpoint create eventgrid --endpoint-name <Event-Grid-endpoint-name> --eventgrid-resource-group <Event-Grid-resource-group-name> --eventgrid-topic <your-Event-Grid-topic-name> -n <your-Azure-Digital-Twins-instance-name>
```

Now, the event grid topic is available as an endpoint inside of Azure Digital Twins, under the name specified with the `--endpoint-name` argument. You will typically use that name as the target of an **event route**, which you'll create [later in this article](#event-routes-with-apis-and-the-c-sdk) using the Azure Digital Twins service API.

### Create an Event Hubs or Service Bus endpoint

The process for creating Event Hubs or Service Bus endpoints is similar to the Event Grid process shown above.

First, create your resources that you'll use as the endpoint. Here is what is required:
* Service Bus: _Service Bus namespace_, _Service Bus topic_, _Authorization rule_
* Event Hubs: _Event Hubs namespace_, _event hub_, _Authorization rule_

Then, use the following commands to create the endpoints in Azure Digital Twins: 

* Add Service Bus Topic endpoint (requires a pre-created Service Bus resource)
```azurecli 
az dt endpoint create servicebus --endpoint-name <Service-Bus-endpoint-name> --servicebus-resource-group <Service-Bus-resource-group-name> --servicebus-namespace <Service-Bus-namespace> --servicebus-topic <Service-Bus-topic-name> --servicebus-policy <Service-Bus-topic-policy> -n <your-Azure-Digital-Twins-instance-name>
```

* Add Event Hubs endpoint (requires pre-created Event Hubs resource)
```azurecli
az dt endpoint create eventhub --endpoint-name <Event-Hub-endpoint-name> --eventhub-resource-group <Event-Hub-resource-group> --eventhub-namespace <Event-Hub-namespace> --eventhub <Event-Hub-name> --eventhub-policy <Event-Hub-policy> -n <your-Azure-Digital-Twins-instance-name>
```

### Create an endpoint with dead-lettering

When an endpoint can't deliver an event within a certain time period or after trying to deliver the event a certain number of times, it can send the undelivered event to a storage account. This process is known as **dead-lettering**.

In order to create an endpoint with dead-lettering enabled, you must use the [ARM APIs](https://docs.microsoft.com/rest/api/digital-twins/controlplane/endpoints/digitaltwinsendpoint_createorupdate) to create your endpoint. 

Before setting the dead-letter location, you must have a storage account with a container. You provide the URL for this container when creating the endpoint. The dead-letter is provided as a container URL with a SAS token. That token needs only `write` permission for the destination container within the storage account. The fully formed URL will be in the format of:
`https://<storageAccountname>.blob.core.windows.net/<containerName>?<SASToken>`

To learn more about SAS tokens, see: [Grant limited access to Azure Storage resources using shared access signatures (SAS)](https://docs.microsoft.com/azure/storage/common/storage-sas-overview)

To learn more about dead-lettering, see [Concepts: Event Routes](./concepts-route-events.md#dead-letter-events)

#### Configuring the endpoint

When creating an endpoint, add a `deadLetterSecret` to the `properties` object in the body of the request, which contains a container URL and SAS token for your storage account.

```json
{
  "properties": {
    "endpointType": "EventGrid",
    "TopicEndpoint": "https://contosoGrid.westus2-1.eventgrid.azure.net/api/events",
    "accessKey1": "xxxxxxxxxxx",
    "accessKey2": "xxxxxxxxxxx",
    "deadLetterSecret":"https://<storageAccountname>.blob.core.windows.net/<containerName>?<SASToken>"
  }
}
```

For more information, see the Azure Digital Twins REST API documentation: [Endpoints - DigitalTwinsEndpoint CreateOrUpdate](https://docs.microsoft.com/rest/api/digital-twins/controlplane/endpoints/digitaltwinsendpoint_createorupdate).

### Message storage schema

Dead-lettered messages will be stored in the following format in your storage account:

`{container}/{endpointName}/{year}/{month}/{day}/{hour}/{eventId}.json`

Dead-lettered messages will match the schema of the original event that was intended to be delivered to your original endpoint.

Here is an example of a dead-letter message for a [twin create notification](./how-to-interpret-event-data.md#digital-twin-life-cycle-notifications):

```json
{
  "specversion": "1.0",
  "id": "xxxxxxxx-xxxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "type": "Microsoft.DigitalTwins.Twin.Create",
  "source": "<yourInstance>.api.<yourregion>.da.azuredigitaltwins-test.net",
  "data": {
    "$dtId": "<yourInstance>xxxxxxxx-xxxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "$etag": "W/\"xxxxxxxx-xxxxx-xxxx-xxxx-xxxxxxxxxxxx\"",
    "TwinData": "some sample",
    "$metadata": {
      "$model": "dtmi:test:deadlettermodel;1",
      "room": {
        "lastUpdateTime": "2020-10-14T01:11:49.3576659Z"
      }
    }
  },
  "subject": "<yourInstance>xxxxxxxx-xxxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "time": "2020-10-14T01:11:49.3667224Z",
  "datacontenttype": "application/json",
  "traceparent": "00-889a9094ba22b9419dd9d8b3bfe1a301-f6564945cb20e94a-01"
}
```

## Event routes (with APIs and the C# SDK)

To actually send data from Azure Digital Twins to an endpoint, you'll need to define an **event route**. Azure Digital Twins **EventRoutes APIs** let developers wire up event flow, throughout the system and to downstream services. Read more about event routes in [*Concepts: Routing Azure Digital Twins events*](concepts-route-events.md).

The samples in this section use the [.NET (C#) SDK](https://www.nuget.org/packages/Azure.DigitalTwins.Core).

**Prerequisite**: You need to create endpoints as described earlier in this article before you can move on to creating a route. You can proceed to creating an event route once your endpoints are finished setting up.

>[!NOTE]
>If you have recently deployed your endpoints, validate that they're finished deploying **before** attempting to use them for a new event route. If route deployment fails because the endpoints aren't ready, wait a few minutes and try again.
>
> If you are scripting this flow, you may want to account for this by building in 2-3 minutes of wait time for the endpoint service to finish deploying before moving on to route setup.

### Create an event route

Event routes are defined using [data plane APIs](how-to-use-apis-sdks.md#overview-data-plane-apis). 

A route definition can contain these elements:
* The route name you want to use
* The name of the endpoint you want to use
* A filter that defines which events are sent to the endpoint 

If there is no route name, no messages are routed outside of Azure Digital Twins. 
If there is a route name and the filter is `true`, all messages are routed to the endpoint. 
If there is a route name and a different filter is added, messages will be filtered based on the filter.

One route should allow multiple notifications and event types to be selected. 

`CreateEventRoute` is the SDK call that is used to add an event route. Here is an example of its usage:

```csharp
EventRoute er = new EventRoute("endpointName");
er.Filter = "true"; //Filter allows all messages
await client.CreateEventRoute("routeName", er);
```

> [!TIP]
> All SDK functions come in synchronous and asynchronous versions.

### Event route sample code

The following code sample shows how to create, list, and delete an event route:
```csharp
try
{
    Console.WriteLine("Create a route: testRoute1");
    EventRoute er = new EventRoute("< your - endpoint - name >");
    // Make a filter that passes everything
    er.Filter = "true";
    client.CreateEventRoute("< your - route - name >", er);
    Console.WriteLine("Create route succeeded. Now listing routes:");
    Pageable <EventRoute> result = client.GetEventRoutes();
    foreach (EventRoute r in result)
    {
        Console.WriteLine($"Route {r.Id} to endpoint {r.EndpointName} with filter {r.Filter} ");
    }
    Console.WriteLine("Deleting routes:");
    foreach (EventRoute r in result)
    {
        Console.WriteLine($"Deleting route {r.Id}:");
        client.DeleteEventRoute(r.Id);
    }
}
catch (RequestFailedException e)
{
    Console.WriteLine($"*** Error in event route processing ({e.ErrorCode}):\n${e.Message}");
}
```

### Filter events

Without filtering, endpoints receive a variety of events from Azure Digital Twins:
* Telemetry fired by [digital twins](concepts-twins-graph.md) using the Azure Digital Twins service API
* Twin property change notifications, fired on property changes for any twin in the Azure Digital Twins instance
* Life-cycle events, fired when twins or relationships are created or deleted
* Model change events, fired when [models](concepts-models.md) configured in an Azure Digital Twins instance are added or deleted

You can restrict the events being sent by adding a **filter** for an endpoint to your event route.

To add a filter, you can use a PUT request to *https://{YourHost}/EventRoutes/myNewRoute?api-version=2020-10-31* with the following body:

```json  
{
    "endpointName": "<endpoint-name>",
    "filter": "<filter-text>"
}
``` 

Here are the supported route filters. Use the detail in the *Filter text schema* column to replace the `<filter-text>` placeholder in the request body above.

[!INCLUDE [digital-twins-route-filters](../../includes/digital-twins-route-filters.md)]

## Manage endpoints and routes with CLI

Endpoints and routes can also be managed using the Azure Digital Twins CLI. For more information about using the CLI and what commands are available, see [*How-to: Use the Azure Digital Twins CLI*](how-to-use-cli.md).

[!INCLUDE [digital-twins-known-issue-cloud-shell](../../includes/digital-twins-known-issue-cloud-shell.md)]

[!INCLUDE [digital-twins-route-metrics](../../includes/digital-twins-route-metrics.md)]

## Next steps

Read about the different types of event messages you can receive:
* [*How-to: Interpret event data*](how-to-interpret-event-data.md)