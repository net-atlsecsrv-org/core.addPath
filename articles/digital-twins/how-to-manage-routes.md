---
# Mandatory fields.
title: Manage endpoints and routes
titleSuffix: Azure Digital Twins
description: See how to set up and manage endpoints and event routes for Azure Digital Twins data.
author: alexkarcher-msft
ms.author: alkarche # Microsoft employees only
ms.date: 6/23/2020
ms.topic: how-to
ms.service: digital-twins

# Optional fields. Don't forget to remove # if you need a field.
# ms.custom: can-be-multiple-comma-separated
# ms.reviewer: MSFT-alias-of-reviewer
# manager: MSFT-alias-of-manager-or-PM-counterpart
---

# Manage endpoints and routes in Azure Digital Twins

In Azure Digital Twins, you can route [event notifications](how-to-interpret-event-data.md) to downstream services, or to connect to compute resources. This is done by first setting up **endpoints** that can receive the events, followed by the  [**event routes**](concepts-route-events.md) that specify which events generated by Azure Digital Twins are delivered to which endpoints.

Supported endpoint types include:
* [Event Hub](../event-hubs/event-hubs-about.md)
* [Event Grid](../event-grid/overview.md)
* [Service Bus](../service-bus-messaging/service-bus-messaging-overview.md)

For more information on the different endpoints, see [*Choose between Azure messaging services*](https://docs.microsoft.com/azure/event-grid/compare-messaging-services).

Endpoints and routes are managed with the [**EventRoutes APIs**](how-to-use-apis-sdks.md), the [.NET (C#) SDK](https://github.com/Azure/azure-sdk-for-net/tree/master/sdk/digitaltwins/Azure.DigitalTwins.Core), or the [Azure Digital Twins CLI](how-to-use-cli.md). They can also be managed through the [Azure portal](https://portal.azure.com).

## Create an endpoint for Azure Digital Twins

To link an endpoint to Azure Digital Twins, the Event Hub, event grid topic, or Service Bus that you're using for the endpoint needs to exist already. 

The following example shows how to create an event grid topic using the Azure CLI:

```azurecli
az eventgrid topic create -g <your-resource-group-name> --name <your-topic-name> -l <region>
```

> [!TIP]
> To output a list of Azure region names that can be passed into commands in the Azure CLI, run this command:
> ```azurecli
> az account list-locations -o table
> ```

Once you have created the topic, you can link it to Azure Digital Twins with the following command:

```azurecli
az dt endpoint create eventgrid --endpoint-name <Event-Grid-endpoint-name> --eventgrid-resource-group <Event-Grid-resource-group-name> --eventgrid-topic <your-Event-Grid-topic-name> -n <your-Azure-Digital-Twins-instance-name>
```

This makes the event grid topic available inside of Azure Digital Twins, under the name specified with the `--endpoint-name` argument. You will typically use that name as the target of an **event route**, which you'll create in the next section using the Azure Digital Twins service API.

Equivalent commands exist for Event Hub and Service Bus endpoints:

* Add Service Bus Topic endpoint (requires a pre-created Service Bus resource)
```azurecli 
az dt endpoint create servicebus --endpoint-name <Service-Bus-endpoint-name> --servicebus-resource-group <Service-Bus-resource-group-name> --servicebus-namespace <Service-Bus-namespace> --servicebus-topic <Service-Bus-topic-name> --servicebus-policy <Service-Bus-topic-policy> -n <your-Azure-Digital-Twins-instance-name>
```

* Add Event Hub endpoint (requires pre-created Event Hub resource)
```azurecli
az dt endpoint create eventhub --endpoint-name <Event-Hub-endpoint-name> --eventhub-resource-group <Event-Hub-resource-group> --eventhub-namespace <Event-Hub-namespace> --eventhub <Event-Hub-name> --eventhub-policy <Event-Hub-policy> -n <your-Azure-Digital-Twins-instance-name>
```

## Manage event routes with APIs

To actually send data from Azure Digital Twins to an endpoint, you need to define an event route. Azure Digital Twins **EventRoutes APIs** let developers wire up event flow, throughout the system and to downstream services. Read more about event routes in [*Concepts: Routing Azure Digital Twins events*](concepts-route-events.md).

You can proceed to creating an event route once your endpoints are finished setting up.

>[!NOTE]
>If you have recently deployed your endpoints, validate that they're finished deploying **before** attempting to use them for a new event route. If route deployment fails because the endpoints aren't ready, wait a few minutes and try again.
>
> If you are scripting this flow, you may want to account for this by building in 2-3 minutes of wait time for the endpoint service to finish deploying before moving on to route setup.

The samples in this article use the C# SDK.

Event routes are defined using data plane APIs. A route definition can contain these elements:
* The route ID you want to use
* The name of the endpoint you want to use
* A filter that defines which events are sent to the endpoint 

If there is no route ID, no messages are routed outside of Azure Digital Twins. 
If there is a route ID and the filter is `true`, all messages are routed to the endpoint. 
If there is a route ID and a different filter is added, messages will be filtered based on the filter.

One route should allow multiple notifications and event types to be selected. 

`CreateEventRoute` is the SDK call that is used to add an event route. Here is an example of its usage:

```csharp
EventRoute er = new EventRoute("endpointName");
er.Filter("true"); //Filter allows all messages
await client.CreateEventRoute("routeName", er);
```

> [!TIP]
> All SDK functions come in synchronous and asynchronous versions.

### Event route sample code

The following code sample shows how to create, list, and delete an event route:
```csharp
try
{
    Console.WriteLine("Create a route: testRoute1");
    EventRoute er = new EventRoute("< your - endpoint - name >");
    // Make a filter that passes everything
    er.Filter = "true";
    client.CreateEventRoute("< your - route - name >", er);
    Console.WriteLine("Create route succeeded. Now listing routes:");
    Pageable <EventRoute> result = client.GetEventRoutes();
    foreach (EventRoute r in result)
    {
        Console.WriteLine($"Route {r.Id} to endpoint {r.EndpointId} with filter {r.Filter} ");
    }
    Console.WriteLine("Deleting routes:");
    foreach (EventRoute r in result)
    {
        Console.WriteLine($"Deleting route {r.Id}:");
        client.DeleteEventRoute(r.Id);
    }
}
catch (RequestFailedException e)
{
    Console.WriteLine($"*** Error in event route processing ({e.ErrorCode}):\n${e.Message}");
}
```

### Filter events

Without filtering, endpoints receive a variety of events from Azure Digital Twins:
* Telemetry fired by [digital twins](concepts-twins-graph.md) using the Azure Digital Twins service API
* Twin property change notifications, fired on property changes for any twin in the Azure Digital Twins instance
* Life-cycle events, fired when twins or relationships are created or deleted
* Model change events, fired when [models](concepts-models.md) configured in an Azure Digital Twins instance are added or deleted

You can restrict the events being sent by adding a filter to an endpoint.

To add a filter, you can use a PUT request to *https://{YourHost}/EventRoutes/myNewRoute?api-version=2020-05-31-preview* with the following body:

```json  
{
    "endpointName": "<endpoint-name>",
    "filter": "<filter-text>"
}
``` 

Here are the supported route filters.

| Filter name | Description | Filter schema | Supported values | 
| --- | --- | --- | --- |
| Type | The [type of event](./concepts-route-events.md#types-of-event-messages) flowing through your digital twin instance | `"filter" : "type = '<eventType>'"` | `Microsoft.DigitalTwins.Twin.Create` <br> `Microsoft.DigitalTwins.Twin.Delete` <br> `Microsoft.DigitalTwins.Twin.Update`<br>`Microsoft.DigitalTwins.Relationship.Create`<br>`Microsoft.DigitalTwins.Relationship.Update`<br> `Microsoft.DigitalTwins.Relationship.Delete` <br> `microsoft.iot.telemetry`  |
| Source | Name of Azure Digital Twins instance | `"filter" : "source = '<hostname>'"`|  **For notifications**: `<yourDigitalTwinInstance>.<yourRegion>.azuredigitaltwins.net` <br> **For telemetry**: `<yourDigitalTwinInstance>.<yourRegion>.azuredigitaltwins.net/digitaltwins/<twinId>`|
| Subject | A description of the event in the context of the event source above | `"filter": " subject = '<subject>'"` | **For notifications**: The subject is `<twinid>` <br> or a URI format for subjects, which are uniquely identified by multiple parts or IDs:<br>`<twinid>/relationships/<relationshipid>`<br> **For telemetry**: The subject is the component path (if the telemetry is emitted from a twin component), such as `comp1.comp2`. If the telemetry is not emitted from a component, then its subject field is empty. |
| Data schema | DTDL model ID | `"filter": "dataschema = 'dtmi:example:com:floor4;2'"` | **For telemetry**: The data schema is the model ID of the twin or the component that emits the telemetry <br>**For notifications**: Data schema is not supported|
| Content type | Content type of data value | `"filter": "datacontenttype = '<contentType>'"` | `application/json` |
| Spec version | The version of the event schema you are using | `"filter": "specversion = '<version>'"` | Must be `1.0`. This indicates the CloudEvents schema version 1.0 |
| True / False | Allows creating a route with no filtering, or disabling a route | `"filter" : "<true/false>"` | `true` = route is enabled with no filtering <br> `false` = route is disabled |
<!--
| ID | *Not implemented for public preview* | "filter": "id = '…'" | |
| Schema | *Not implemented for public preview*  | "filter": "dataschema = '…'" | |
-->

It is also possible to combine filters using the following operations:

| Filter name | Filter schema | Example | 
| --- | --- | --- |
| AND / OR | `"filter": "<filter1> AND <filter2>"` | `"filter": "type != 'microsoft.iot.telemetry' AND datacontenttype = 'application/json'"` |
| AND / OR | `"filter": "<filter1> OR <filter2>"` | `"filter": "type != 'microsoft.iot.telemetry' OR datacontenttype = 'application/json'"` |
| Nested operations | `"filter": "(<Comparison1>) AND (<Comparison2>)"` | `"filter": "(type != 'microsoft.iot.telemetry' OR datacontenttype = 'application/json') OR (specversion != '1.0')"` |

> [!NOTE]
> During preview, only string equality is supported (=, !=).

When you implement or update a filter, the change may take a few minutes to be reflected in the data pipeline.

## Manage endpoints and routes with CLI

Endpoints and routes can also be managed using the Azure Digital Twins CLI. The commands can be found in [*How-to: Use the Azure Digital Twins CLI*](how-to-use-cli.md).

## Monitor event routes

Routing metrics such as count, latency, and failure rate can be viewed in the [Azure portal](https://portal.azure.com/). 

From the portal homepage, search for your Azure Digital Twins instance to pull up its details. Select the **Metrics** option from the Azure Digital Twins instance's menu to bring up the *Metrics* page.

:::image type="content" source="media/how-to-manage-routes/metrics.png" alt-text="Metrics page of an Azure Digital Twins instance in the Azure portal":::

From here, you can view the metrics for your instance and create custom views.

## Next steps

Read about the different types of event messages you can receive:
* [*How-to: Interpret event data*](how-to-interpret-event-data.md)
