---
title: Troubleshooting SQL insights (preview)
description: Troubleshooting SQL insights in Azure Monitor
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/04/2021
---

# Troubleshooting SQL insights (preview)
To troubleshoot data collection issues in SQL insights, check the status of the monitoring machine in the **Manage profile** tab. This will have one of the following states:

- Collecting 
- Not collecting 
- Collecting with errors 
 
Click the **Status** to drill in to see logs and further details, which may help you resolve the problem. 

:::image type="content" source="media/sql-insights-enable/monitoring-machine-status.png" alt-text="Monitoring machine status":::

## Not collecting state 
The monitoring machine has a state of *Not collecting* if there's no data in *InsightsMetrics* for SQL in the last 10 minutes. 

SQL insights uses the following query to retrieve this information:

```
InsightsMetrics 
    | extend Tags = todynamic(Tags) 
    | extend SqlInstance = tostring(Tags.sql_instance) 
    | where TimeGenerated > ago(10m) and isnotempty(SqlInstance) and Namespace == 'sqlserver_server_properties' and Name == 'uptime' 
```

Check if there are any logs from Telegraf that helps identify the root cause the issue. If there are log entries, you can click *Not collecting* and check the logs and troubleshooting info for common problems. 


If there are no logs, then you must check the logs on the monitoring virtual machine for the following services installed by two virtual machine extensions:

- Microsoft.Azure.Monitor.AzureMonitorLinuxAgent 
  - Service: mdsd 
- Microsoft.Azure.Monitor.Workloads.Workload.WLILinuxExtension 
  - Service: wli 
  - Service: ms-telegraf 
  - Service: td-agent-bit-wli 
  - Extension log to check install failures: /var/log/azure/Microsoft.Azure.Monitor.Workloads.Workload.WLILinuxExtension/wlilogs.log 



### wli service logs 

Service logs: `/var/log/wli.log`

To see recent logs: `tail -n 100 -f /var/log/wli.log`
 

If you see the following error log, it indicates a problem with the **mdsd** service.

```
2021-01-27T06:09:28Z [Error] Failed to get config data. Error message: dial unix /var/run/mdsd/default_fluent.socket: connect: no such file or directory 
```


### Telegraf service logs 

Service logs: `/var/log/ms-telegraf/telegraf.log`

To see recent logs: `tail -n 100 -f /var/log/ms-telegraf/telegraf.log`
To see recent error and warning logs: `tail -n 1000 /var/log/ms-telegraf/telegraf.log | grep "E\!\|W!"`

 The configuration used by telegraf is generated by wli service and placed in: `/etc/ms-telegraf/telegraf.d/wli`
 
If a bad configuration is generated ms-telegraf service may fail to start, check if ms-telegraf service is running with the command: `service ms-telegraf status`

To see error messages from telegraf service run it manually with the following command: 

```
/usr/bin/ms-telegraf --config /etc/ms-telegraf/telegraf.conf --config-directory /etc/ms-telegraf/telegraf.d/wli --test 
```

### mdsd service logs 

Check [Current Limitations](../agents/azure-monitor-agent-overview.md#current-limitations) for the Azure Monitor agent. 


Service logs:  
- `/var/log/mdsd.err`
- `/var/log/mdsd.warn`
- `/var/log/mdsd.info`

To see recent errors: `tail -n 100 -f /var/log/mdsd.err`

 If you need to contact support, collect the following information: 

- Logs in `/var/log/azure/Microsoft.Azure.Monitor.AzureMonitorLinuxAgent/` 
- Log in `/var/log/waagent.log` 
- Logs in `/var/log/mdsd*`
- Files in `/etc/mdsd.d/`
- File `/etc/default/mdsd`

### Invalid monitoring virtual machine configuration

One cause of the *Not Collecting* state is when you have an invalid monitoring virtual machine configuration.  Following is the default configuration:

```json
{
    "version": 1,
    "secrets": {
        "telegrafPassword": {
            "keyvault": "https://mykeyvault.vault.azure.net/",
            "name": "sqlPassword"
        }
    },
    "parameters": {
        "sqlAzureConnections": [
            "Server=mysqlserver.database.windows.net;Port=1433;Database=mydatabase;User Id=telegraf;Password=$telegrafPassword;"
        ],
        "sqlVmConnections": [
        ],
        "sqlManagedInstanceConnections": [
        ]
    }
}
```

This configuration specifies the replacement tokens to be used in the profile configuration on your monitoring virtual machine. It also allows you to reference secrets from Azure Key Vault, so you don't have keep secret values in any configuration, which is strongly recommended.

#### Secrets
Secrets are tokens whose values are retrieved at run time from an Azure Key Vault. A secret is defined by a pair of a Key Vault reference and secret name. This allows Azure Monitor to get the dynamic value of the secret and use it is downstream config references.

You can define as many secrets as needed in the configuration, including secrets stored in separate Key Vaults.

```json
   "secrets": {
        "<secret-token-name-1>": {
            "keyvault": "<key-vault-uri>",
            "name": "<key-vault-secret-name>"
        },
        "<secret-token-name-2>": {
            "keyvault": "<key-vault-uri-2>",
            "name": "<key-vault-secret-name-2>"
        }
    }
```

The permissions to access the Key Vault is provided to a Managed Service Identity on the monitoring virtual machine. Azure Monitor expects the Key Vault to provide at least secrets get permission to the virtual machine. You can enable it from the Azure portal, PowerShell, CLI, or Resource Manager template.

#### Parameters
Parameters are tokens that can be referenced in the profile configuration via JSON templating. Parameters have a name and a value. Values can be any JSON type including objects and arrays. A parameter is referenced in the profile config using its name in this convention `.Parameters.<name>`.

Parameters can reference secrets in Key Vault using the same convention. For example, `sqlAzureConnections` references the secret `telegrafPassword` using the convention `$telegrafPassword`.

At run time, all parameters and secrets will be resolved and merged with the profile configuration to construct the actual configuration to be used on the machine.

> [!NOTE]
> The parameter names of `sqlAzureConnections`, `sqlVmConnections`, and `sqlManagedInstanceConnections` are all required in the configuration even if you do not have connection strings you will be providing for some of them.


## Collecting with errors state
The monitoring machine will be in state *Collecting with errors* if there's at least one *InsightsMetrics* log but there are also errors in the *Operation* table.

SQL insights uses the following queries to retrieve this information:

```
InsightsMetrics 
    | extend Tags = todynamic(Tags) 
    | extend SqlInstance = tostring(Tags.sql_instance) 
    | where TimeGenerated > ago(240m) and isnotempty(SqlInstance) and Namespace == 'sqlserver_server_properties' and Name == 'uptime' 
```

```
Operation 
 | where OperationCategory == "WorkloadInsights" 
 | summarize Errors = countif(OperationStatus == 'Error') 
```

For common cases, we provide troubleshooting knowledge in our logs view: 

:::image type="content" source="media/sql-insights-enable/troubleshooting-logs-view.png" alt-text="Troubleshooting logs view.":::



## Next steps

- Get details on [enabling SQL insights](sql-insights-enable.md).
